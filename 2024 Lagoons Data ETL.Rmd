---
title: "2021/2024 Lagoons Data ETL"
author: "SDMiller"
date: "`r Sys.Date()`"
output: html_document
---

# Intro

This document describes the steps I used to implement quality control on the data deliverables for 2021/2024 for ingestion into the ARCN_Lagoons database.

These data were received from WCS, Kevin Fraley.

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Load libraries
#library(RODBC)
# library(knitr)
# library(ggplot2)
# library(sp)
# library(sf)
# library(sqldf)
library(tidyverse)
library(readxl)
library(odbc)
# library(leaflet)

connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna_dev", Database = "ARCN_Lagoons")
dir = r'(O:\Monitoring\Vital Signs\Lagoon Communities and Ecosystems\Data\2024 Lagoons Sampling\Deliverables processing/)'
dir = r'(C:\Work\VitalSigns\ARCN Lagoons\Data\2024 Lagoons Sampling\Deliverables processing/)' # copied local for speed
filename = r'(2021-2024 WCS CAKR Coastal Lagoons Data Received 2024-07-31 From KFraley.xlsx)'
workbook = paste(dir,filename,sep="")

```

# Functions
```{r}
# Example database connection
# connection = dbConnect(odbc(),Driver = "Sql Server",Server = "inpyugamsvm01\\nuna_dev", Database = "ARCN_Lagoons")

# Function to query the lagoons database for the existence of Lagoon using the odbc database connection DatabaseConnection
# Returns boolean.
LagoonExists = function(DatabaseConnection, Lagoon) {
  tryCatch({
    # Build an SQL query
    Sql = paste("SELECT Lagoon FROM Lagoons WHERE Lagoon = '", Lagoon, "'", sep = "")
    
    # Execute the query
    result = dbGetQuery(DatabaseConnection, Sql)
    
    # Return true or false depending on whether we get a row or not
    if (nrow(result) == 0) {
      return(paste("INSERT INTO Lagoons(Lagoon)VALUES('",Lagoon,"') -- ",Lagoon,"\n",sep=""))
    } else {
      return(paste("-- Lagoon ",Lagoon,"Exists\n"))
    }
  }, error = function(e) {
    # Bummer
    cat("Error: ", e$message,"\n",Sql,"\n")
    return(NULL) # or handle the error as appropriate
  })
}
# Test cat(LagoonExists(connection,'Anigaaqi'))

# Function to query the lagoons database for the existence of Lagoon and Site using the odbc database connection DatabaseConnection
# Returns boolean.
SiteExists = function(DatabaseConnection, Lagoon,Site,Lat='NULL',Lon='NULL') {
  tryCatch({
    # Build an SQL query
    Sql = paste("SELECT Lagoon,Site FROM Sites WHERE Lagoon = '", Lagoon, "' And Site = '",Site,"'", sep = "")

    # Execute the query
    result = dbGetQuery(DatabaseConnection, Sql)
    
    # Return true or false depending on whether we get a row or not
    if (nrow(result) == 0) {
      
      if(is.na(Lat) | Lat == 0){
        return(paste("INSERT INTO Sites(Lagoon,Site,Latitude,Longitude)VALUES('",Lagoon,"','",Site,"',NULL,NULL)",sep=""))
      } else {
        return(paste("INSERT INTO Sites(Lagoon,Site,Latitude,Longitude)VALUES('",Lagoon,"','",Site,"',",Lat,",",Lon,")",sep=""))
      }

    } else {
      return(paste("-- Site ",Lagoon,"-",Site,"Exists"))
    }
    
  }, error = function(e) {
    # Bummer
    cat("Error: ", e$message,"\n",Sql,"\n")
    return(NULL) # or handle the error as appropriate
  })
}
# cat(SiteExists(connection,'Anigaaq','ANI_ME',65,-157),sep="")
# cat(SiteExists(connection,'Anigaaq','ANI_ME',0,0),sep="")
# cat(SiteExists(connection,'Anigaaq','ANI_ME',NA,NA),sep="")
# cat(SiteExists(connection,'Anigaaq','ANI_ME'),sep="")


# Function to query the lagoons database for the existence of a lagoons sampling event using the odbc database connection DatabaseConnection
# Returns boolean.
SamplingEventExists = function(DatabaseConnection, Lagoon,Date,Site) {
  tryCatch({
    # Build an SQL query
    Sql = paste("SELECT Lagoon,[Date],Site FROM SamplingEvents WHERE Lagoon = '", Lagoon, "' And [Date] = '",Date,"' And Site = '",Site,"'", sep = "")

    # Execute the query
    result = dbGetQuery(DatabaseConnection, Sql)
    
    
    # Return true or false depending on whether we get a row or not
    if (nrow(result) == 0) {
        return(paste("INSERT INTO SamplingEvents(Lagoon,Site,Date)VALUES('",Lagoon,"','",Site,"','",Date,"')",sep=""))
    } else {
      return(paste("-- Site ",Lagoon,"-",Site,"Exists"))
    }
    
    
  }, error = function(e) {
    # Bummer
    cat("Error: ", e$message,"\n",Sql,"\n")
    return(NULL) # or handle the error as appropriate
  })
}
#cat(SamplingEventExists(connection,'Anigaaq','2024-06-23','ANI_ME'))


# Filters FishData for CommonName (match case) and updates the records with Family,Genus,Species
# UpdateFishTaxa = function(CommonName,Family,Genus,Species){
#   cat(CommonName,Family,Genus,Species,FishData$CommonName,FishData$CommonName==CommonName,"\n",sep="")
#   FishData$Family = ifelse(FishData$CommonName==CommonName,'Gasterosteidae',FishData$Family)
#   FishData$Genus = ifelse(FishData$CommonName==CommonName,'Gasterosteus',FishData$Genus)
#   FishData$Species = ifelse(FishData$CommonName==CommonName,'Gasterosteus',FishData$Species)
# }
# UpdateFishTaxa('Juvenile salmon','Salmonidae','Onchorhynchus','spp.')
# # Find out which species didn't map
# FishData %>% filter(is.na(Genus)==TRUE) %>% distinct(CommonName)
```

# Deliverable L11-Fish data processing

This section contains processing steps to get the fish data (Deliverable L11) processed for ingestion into the master lagoons monitoring database.

## Step 1. Load the worksheet

```{r}
# Get the worksheet names
#excel_sheets(workbook)

# Load the fish data
worksheet = "Fish Data 2024"
fd = readxl::read_excel(workbook,worksheet)

```

## Step 2. Data quality checks

```{r}

# Use these tools to check that data types match expected attributes, statistics such as min/max, etc. are as expected
glimpse(fd)

# view(fd)

fd %>% distinct(Year)
fd %>% distinct(Date)
fd %>% distinct(Lagoon)
fd %>% distinct(Site)
fd %>% distinct(`Gear Type`)
fd %>% distinct(`Set Time (hours)`)
fd %>% distinct(`Check Number`)
fd %>% distinct(`Check Time`)
fd %>% distinct(Species)
fd %>% distinct(Year)
fd %>% distinct(`Fork Length (mm)`) %>% arrange(`Fork Length (mm)`)
fd %>% distinct(ForkLength) %>% arrange(`Fork Length (mm)`)


```

## Step 3. Fix defects, 2024

### 2024 Lagoons existence check

```{r}
# make sure lagoons exist
Lagoons = as.data.frame(fd %>% distinct(Lagoon))
# Rabbit Creek is not a lagoon
for(i in 1:nrow(Lagoons)){
  Lagoon = Lagoons[i,1]
  cat(LagoonExists(connection,Lagoon))
  #cat("INSERT INTO Lagoons(Lagoon)VALUES('",Lagoon,"') -- ",Lagoon," ",Exists,"\n",sep="")
}

# fix Aniqaaq
fd$Lagoon = ifelse(fd$Lagoon=='Aniqaaq','Anigaaq',fd$Lagoon)

# i don't know where rabbit creek or Situkuyok is, no spatial data
# write to a file and filter out of the dataset
#write.csv(fd %>% filter(Lagoon == 'Rabbit Creek'),paste(dir,"L11 Rabbit Creek Fish Data.csv",sep=""))
#write.csv(fd %>% filter(Lagoon == 'Situkuyok'),paste(dir,"L11 Situkuyok Fish Data.csv",sep=""))
fd = fd %>% filter(Lagoon != 'Rabbit Creek' & Lagoon != 'Situkuyok')

```

### 2024 Sites existence check

```{r}
# Fix Sites
Sites = fd %>% distinct(Lagoon,Site,Lat,Long)
Sites
cat("BEGIN TRANSACTION -- COMMIT ROLLBACK\n")
for(i in 1:nrow(Sites)){
  Lagoon = Sites[i,'Lagoon']
  Site = Sites[i,'Site']
  Lat = Sites[i,'Lat']
  Lon = Sites[i,'Long']
  cat(SiteExists(connection,Lagoon,Site,Lat,Lon)," -- ",i,"\n",sep="")
}

```

### 2024 Sampling Events existence check

```{r}
# Fix Sites
Events = fd %>% distinct(Lagoon,Date,Site)
Events$RealDate = as.character(Events$Date)
Events
glimpse(Events)
cat("BEGIN TRANSACTION -- COMMIT ROLLBACK\n")
cat("-- ",nrow(Events)," rows\n")
for(i in 1:nrow(Events)){
  Lagoon = Events[i,'Lagoon']
  Site = Events[i,'Site']
  Date = Events[i,'RealDate']
  cat(SamplingEventExists(connection,Lagoon,Date,Site),"-- ",i,"\n")
}

```

### Fix Gear type
```{r}
# Move gear type to CollectionMethod to preserve gear type
fd$CollectionMethod = fd$`Gear Type`
fd$CollectionMethod = ifelse(fd$`Gear Type`=='offshore gillnet','Gillnet',fd$CollectionMethod)
fd$CollectionMethod = ifelse(fd$`Gear Type`=='onshore gillnet','Gillnet',fd$CollectionMethod)
fd$CollectionMethod = ifelse(fd$`Gear Type`=='beach Seine','Beach Seine',fd$CollectionMethod)
fd$CollectionMethod = ifelse(fd$`Gear Type`=='Onshore gillnet','Gillnet',fd$CollectionMethod)
fd$CollectionMethod = ifelse(fd$`Gear Type`=='Fike','Fyke',fd$CollectionMethod)

fd %>% distinct(`Gear Type`,CollectionMethod)

```

### Fix Set time
```{r}
fd %>% distinct(`Set Time (hours)`)
# These should be in minutes
fd$SetTime_Min = as.integer(fd$`Set Time (hours)`*60)

fd %>% distinct(`Set Time (hours)`,SetTime_Min)


```


### Fix Check Time
```{r}
fd %>% distinct(`Check Time`)
fd$CheckTime= ifelse(!is.na(fd$`Check Time`), paste(fd$`Check Time`,":00",sep=""),NA)

fd %>% distinct(CheckTime)

```
### Fix Species
```{r}
fd %>% distinct(Species)
fd$CommonName = fd$Species

fd$CommonName = ifelse(fd$Species=='No fish',NA,fd$CommonName)
fd$CommonName = ifelse(fd$Species=='No Fish',NA,fd$CommonName)
fd %>% distinct(CommonName)
```

### Fix Fork Length
```{r}

# Fork length is character because of censored data. Some values have a '+', for example
fd$ForkLength = ifelse(is.na(as.numeric(fd$`Fork Length (mm)`)), NA, as.numeric(fd$`Fork Length (mm)`))

# Fix by moving the text values into a new column
fd$ForkLengthText = ifelse(is.na(as.numeric(fd$`Fork Length (mm)`)), fd$`Fork Length (mm)`, NA)

# Flag the text fork length data
fd$ForkLengthFlag = ifelse(!is.na(fd$ForkLengthText),6,NA)

# Get the numeric value of fork length text and load it into ForkLength
fd$ForkLength = ifelse(
  is.na(as.numeric(fd$`Fork Length (mm)`)),
  gsub("[^0-9]", "", fd$ForkLengthText)
  ,fd$ForkLength
)
#fd %>% filter(ForkLengthFlag == 6) %>% mutate(ForkLength = gsub("[^0-9]", "", ForkLengthText)) %>% select(ForkLength,ForkLengthText,ForkLengthFlag) 

fd$ForkLength = ifelse(fd$ForkLength == 150300,225,fd$ForkLength)

# check work
#fd %>% select(`Fork Length (mm)`,ForkLength,ForkLengthText,ForkLengthFlag) %>% arrange(ForkLength)
fd %>% distinct(ForkLength,`Fork Length (mm)`,ForkLengthText,ForkLengthFlag) %>% arrange(ForkLengthText)

```

### Fix Counts

```{r}
# Move the text counts to a new column
fd$Count_Text  = NULL

# Fix by moving the text values into a new column
fd$CountText = ifelse(is.na(as.numeric(fd$Count)), fd$Count, NA)

# Flag the text count data
fd$CountFlag = ifelse(!is.na(fd$CountText),7,NA)

# Get the numeric value of count and load it into Count
fd$Count = ifelse(
  is.na(as.numeric(fd$Count)),
  gsub("[^0-9]", "", fd$CountText)
  ,fd$Count
)



fd %>% distinct(CountText,Count,CountFlag) %>% arrange(CountText,Count)

fd %>% select(Lagoon,Site,Date,CommonName,Count,CountText,CountFlag) %>% arrange(Count,CountText,CountFlag,Lagoon,Site,Date,CommonName)

```
### Fix Lat Lon

```{r}
fd %>% distinct(Lat) %>% arrange(Lat)
fd %>% distinct(Long) %>% arrange(Long)
```



# Step 4. Join the fish scientific names
```{r}
fb = dbGetQuery(connection,"SELECT * from fishbase")
fb$CommonNameUpper = toupper(fb$FBname)
fd$CommonNameUpper = toupper(fd$CommonName)
x = as.data.frame(left_join(fd,fb,by='CommonNameUpper',multiple='first'))
glimpse(x)

### Fix Species
x %>% distinct(Genus,Species.y) %>% arrange(Genus,Species.y)

```


# Step 5. Write the fish deliverable

```{r}


deliverable = sqldf("SELECT Date
,Lagoon
,Site
,Family
,Genus
,[Species.y] as Species
,CommonName
,CollectionMethod
,[Check Number] as CheckNumber
,CheckTime
,SetTime_Min
,Count,CountText,CountFlag
,ForkLength as ForkLength_mm,ForkLengthText,ForkLengthFlag as ForkLength_Flag
,Lat as Latitude
,Long as Longitude
,[Species.x] as CommonNameRecorded
,Notes as Comments
FROM x
ORDER BY Date
,Lagoon
,Site,CollectionMethod,CheckNumber")


glimpse(fd)
library(sqldf)
deliverable = sqldf("SELECT Date
      ,Lagoon
      ,Site
      ,CollectionMethod
      ,Family,Genus,Species,[CommonName]
      ,ForkLength,ForkLengthText,ForkLengthFlag
      ,Lat as Latitude,Long as Longitude
      FROM fd")

write.csv(deliverable,paste(dir,"L11 2024 Lagoons Fish Data.csv",sep=""),row.names = FALSE,na="")

```

